name: Auto Tag and Purge jsDelivr

on:
  push:
    branches:
      - main

jobs:
  tag-and-purge:
    runs-on: ubuntu-latest
    permissions:
      contents: write # 태그 생성을 위한 권한 명시
      
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1. 자동으로 버전 태그 생성 (v1.x.x)
      - name: Auto Tag Generation
        id: tag_version
        uses: anothrNick/github-tag-action@1.64.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WITH_V: true
          DEFAULT_BUMP: patch

      # 2. jsDelivr 캐시 삭제 (최적화 버전)
      - name: Purge jsDelivr cache (@1 focus)
        uses: gacts/purge-jsdelivr-cache@v1
        continue-on-error: true
        with:
          url: |
            https://cdn.jsdelivr.net/gh/adapt-dev-ops/style-guide@1/assets/js/site-forwarding.js
            https://cdn.jsdelivr.net/gh/adapt-dev-ops/style-guide@${{ steps.tag_version.outputs.new_tag }}/assets/js/site-forwarding.js

      # 3. 10초 대기 후 나머지 파일들 Purge (Throttling 방지용)
      - name: Wait for rate limit
        run: sleep 15

      - name: Purge remaining files
        uses: gacts/purge-jsdelivr-cache@v1
        continue-on-error: true
        with:
          url: |
            https://cdn.jsdelivr.net/gh/adapt-dev-ops/style-guide@latest/assets/js/site-common.js
            https://cdn.jsdelivr.net/gh/adapt-dev-ops/style-guide@latest/assets/js/site-ui.js
